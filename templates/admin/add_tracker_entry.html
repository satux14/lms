{% extends "base.html" %}

{% block title %}Add Entry - {{ tracker.tracker_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        {% include 'admin/_sidebar.html' %}

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-edit me-2"></i>Add/Edit Entry
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="{{ url_for('admin_view_daily_tracker', instance_name=instance_name, tracker_id=tracker.id) }}" 
                           class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>{{ _("Back") }} to Tracker
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tracker Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Tracker: {{ tracker.tracker_name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>User:</strong> {{ tracker.user.username }}
                        </div>
                        <div class="col-md-3">
                            <strong>Type:</strong> {{ tracker.tracker_type }}
                        </div>
                        <div class="col-md-3">
                            <strong>Investment:</strong> ₹{{ "%.2f"|format(tracker.investment) }}
                        </div>
                        <div class="col-md-3">
                            <strong>Start Date:</strong> {{ tracker.start_date.strftime('%Y-%m-%d') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Entry Form -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-wpforms me-2"></i>Entry Details
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('admin_add_tracker_entry', instance_name=instance_name, tracker_id=tracker.id) }}">
                                <!-- Day Selection -->
                                <div class="mb-3">
                                    <label for="day" class="form-label">
                                        <i class="fas fa-calendar-day me-2"></i>Day Number *
                                    </label>
                                    <input type="number" class="form-control" id="day" name="day" 
                                           min="0" max="{{ tracker.scheme_period }}" required
                                           placeholder="Enter day number (e.g., 1, 2, 3...)">
                                    <small class="form-text text-muted">Day 0 is the start date, Day 1 is the first day after start, etc.</small>
                                </div>

                                <!-- Daily Payment -->
                                <div class="mb-3">
                                    <label for="daily_payments" class="form-label">
                                        <i class="fas fa-rupee-sign me-2"></i>Daily Payment
                                    </label>
                                    <input type="number" class="form-control" id="daily_payments" name="daily_payments" 
                                           step="0.01" min="0" placeholder="e.g., 500">
                                </div>

                                {% if tracker.tracker_type == 'No Reinvest' %}
                                <!-- Transaction Details (No Reinvest only) -->
                                <div class="mb-3">
                                    <label for="transaction_details" class="form-label">
                                        <i class="fas fa-file-alt me-2"></i>Transaction Details
                                    </label>
                                    <input type="text" class="form-control" id="transaction_details" name="transaction_details" 
                                           placeholder="Transaction reference or details">
                                </div>
                                {% endif %}

                                <!-- Payment Mode -->
                                <div class="mb-3">
                                    <label for="payment_mode" class="form-label">
                                        <i class="fas fa-credit-card me-2"></i>Payment Mode
                                    </label>
                                    <select class="form-select" id="payment_mode" name="payment_mode">
                                        <option value="">Select payment mode...</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="UPI">UPI</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Online">Online</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>


                                {% if tracker.tracker_type == '1L' %}
                                <!-- 1L Enhanced specific fields -->
                                <div class="mb-3">
                                    <label for="reinvest" class="form-label">
                                        <i class="fas fa-redo me-2"></i>Reinvest Amount
                                    </label>
                                    <input type="number" class="form-control" id="reinvest" name="reinvest" 
                                           step="0.01" min="0" placeholder="Amount to reinvest">
                                </div>

                                <div class="mb-3">
                                    <label for="reinvest_from" class="form-label">
                                        <i class="fas fa-info-circle me-2"></i>Reinvest From
                                    </label>
                                    <input type="text" class="form-control" id="reinvest_from" name="reinvest_from" 
                                           placeholder="Source of reinvestment">
                                </div>

                                <div class="mb-3">
                                    <label for="pocket_money" class="form-label">
                                        <i class="fas fa-wallet me-2"></i>Pocket Money
                                    </label>
                                    <input type="number" class="form-control" id="pocket_money" name="pocket_money" 
                                           step="0.01" min="0" placeholder="Pocket money amount">
                                </div>
                                {% endif %}

                                <!-- Notes -->
                                <div class="mb-3">
                                    <label for="notes" class="form-label">
                                        <i class="fas fa-sticky-note me-2"></i>Notes
                                    </label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="Any additional notes or comments"></textarea>
                                </div>

                                <!-- Cashback Points Section -->
                                <div class="card mt-4 border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-coins me-2"></i>Cashback Points (Optional)</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted small mb-3">
                                            Add cashback points to users for this tracker entry.
                                        </p>
                                        <div id="cashbackUsersContainer">
                                            <div class="cashback-user-entry mb-3 p-3 border rounded">
                                                <div class="row">
                                                    <div class="col-md-5 mb-2">
                                                        <label class="form-label small">Username</label>
                                                        <input type="text" class="form-control form-control-sm" 
                                                               name="cashback_username[]" placeholder="Enter username">
                                                    </div>
                                                    <div class="col-md-5 mb-2">
                                                        <label class="form-label small">Points</label>
                                                        <input type="number" class="form-control form-control-sm" 
                                                               name="cashback_points[]" step="0.01" min="0.01" placeholder="0.00">
                                                    </div>
                                                    <div class="col-md-2 mb-2 d-flex align-items-end">
                                                        <button type="button" class="btn btn-danger btn-sm w-100 remove-cashback-user" style="display: none;">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="addCashbackUserBtn">
                                            <i class="fas fa-plus me-2"></i>Add Another User
                                        </button>
                                    </div>
                                </div>

                                <!-- Submit Buttons -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{{ url_for('admin_view_daily_tracker', instance_name=instance_name, tracker_id=tracker.id) }}" 
                                       class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save Entry
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Info Sidebar -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Instructions
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6><i class="fas fa-check-circle me-2 text-success"></i>How to Add Entry</h6>
                            <ol class="small">
                                <li>Select the day number you want to update</li>
                                <li>Enter the daily payment amount (if applicable)</li>
                                <li>Fill in other relevant fields</li>
                                <li>Leave fields empty if no data for that field</li>
                                <li>Click "Save Entry" to update the tracker</li>
                            </ol>

                            <hr>

                            <h6><i class="fas fa-lightbulb me-2 text-warning"></i>Notes</h6>
                            <ul class="small">
                                <li>Day 0 represents the start date</li>
                                <li>Excel formulas will auto-calculate cumulative and balance</li>
                                <li>You can edit existing entries by selecting the same day</li>
                                <li>Only fill fields that are applicable for this tracker type</li>
                            </ul>

                            <hr>

                            <h6><i class="fas fa-calculator me-2 text-info"></i>Auto-calculated Fields</h6>
                            <p class="small">The following fields are automatically calculated by Excel formulas:</p>
                            <ul class="small">
                                <li>Cumulative amounts</li>
                                <li>Balance (for applicable tracker types)</li>
                                <li>Total Invested (for 1L tracker)</li>
                                <li>Date (auto-generated from start date + day)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Quick Reference Card -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-list me-2"></i>Recent Entries
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Day</th>
                                            <th>Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in tracker_data.data %}
                                        {% if row.daily_payments %}
                                        <tr>
                                            <td>{{ row.day }}</td>
                                            <td>₹{{ "%.2f"|format(row.daily_payments) }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-fill form when day is selected (for quick reference)
document.getElementById('day').addEventListener('change', function() {
    const day = parseInt(this.value);
    // You could add AJAX call here to fetch existing data for this day
});

// Cashback user management
let cashbackUserCount = 1;
document.getElementById('addCashbackUserBtn').addEventListener('click', function() {
    cashbackUserCount++;
    const container = document.getElementById('cashbackUsersContainer');
    const newEntry = container.firstElementChild.cloneNode(true);
    
    // Clear input values
    newEntry.querySelector('input[name="cashback_username[]"]').value = '';
    newEntry.querySelector('input[name="cashback_points[]"]').value = '';
    
    // Show remove button
    newEntry.querySelector('.remove-cashback-user').style.display = 'block';
    
    container.appendChild(newEntry);
});

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-cashback-user')) {
        const container = document.getElementById('cashbackUsersContainer');
        if (container.children.length > 1) {
            e.target.closest('.cashback-user-entry').remove();
        }
    }
});
</script>
{% endblock %}

