{% extends "base.html" %}

{% block title %}Approve Tracker Entry - {{ _('The SRS Consulting') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-check-circle me-2"></i>Review Tracker Entry
                </h1>
                <a href="{{ url_for('admin_pending_tracker_entries', instance_name=instance_name) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Pending
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Entry Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <tr>
                            <th width="30%">Tracker:</th>
                            <td>
                                <a href="{{ url_for('admin_view_daily_tracker', instance_name=instance_name, tracker_id=tracker.id) }}">
                                    {{ tracker.tracker_name }}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th>User:</th>
                            <td>{{ tracker.user.username }}</td>
                        </tr>
                        <tr>
                            <th>Day:</th>
                            <td><strong>Day {{ entry.day }}</strong></td>
                        </tr>
                        <tr>
                            <th>Submitted By:</th>
                            <td>{{ entry.submitted_by.username }}</td>
                        </tr>
                        <tr>
                            <th>Submitted At:</th>
                            <td>{{ entry.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                    </table>

                    <h6 class="mt-3 mb-2">Entry Data:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            {% for key, value in entry_data.items() %}
                            <tr>
                                <th width="30%">{{ key.replace('_', ' ').title() }}:</th>
                                <td>
                                    {% if value is number %}
                                        ₹{{ "%.2f"|format(value) }}
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <form method="POST" id="approvalForm">
                <!-- Cashback Points Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Cashback Points</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="enableCashback" name="enable_cashback" 
                                   {% if configured_cashback %}checked{% endif %}>
                            <label class="form-check-label" for="enableCashback">
                                <strong>Enable Cashback</strong>
                            </label>
                        </div>

                        {% if configured_cashback %}
                        <div class="alert alert-info" id="configuredCashbackInfo">
                            <strong>Configured Cashback:</strong>
                            <ul class="mb-0 mt-2">
                                {% for cb in configured_cashback %}
                                <li>{{ cb.username }}: ₹{{ "%.2f"|format(cb.points) }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div id="cashbackContainer" {% if not configured_cashback %}style="display: none;"{% endif %}>
                            {% if configured_cashback %}
                                {% for cb in configured_cashback %}
                                <div class="cashback-entry mb-2">
                                    <div class="input-group">
                                        {% if is_admin and all_users %}
                                        <select class="form-select" name="cashback_username[]" required>
                                            <option value="">Select user...</option>
                                            {% for user in all_users %}
                                            <option value="{{ user.username }}" {% if cb.username == user.username %}selected{% endif %}>
                                                {{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% else %}
                                        <input type="text" class="form-control" name="cashback_username[]" 
                                               value="{{ cb.username }}" placeholder="Enter username" required>
                                        {% endif %}
                                        <input type="number" step="0.01" class="form-control" name="cashback_points[]" 
                                               value="{{ "%.2f"|format(cb.points) }}" placeholder="Points" required>
                                        <button type="button" class="btn btn-danger remove-cashback">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="cashback-entry mb-2">
                                    <div class="input-group">
                                        {% if is_admin and all_users %}
                                        <select class="form-select" name="cashback_username[]">
                                            <option value="">Select user...</option>
                                            {% for user in all_users %}
                                            <option value="{{ user.username }}">
                                                {{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        {% else %}
                                        <input type="text" class="form-control" name="cashback_username[]" placeholder="Enter username">
                                        <small class="form-text text-muted d-block mt-1">Type the username manually</small>
                                        {% endif %}
                                        <input type="number" step="0.01" class="form-control" name="cashback_points[]" placeholder="Points">
                                        <button type="button" class="btn btn-danger remove-cashback" style="display: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2" id="addCashback" {% if not configured_cashback %}style="display: none;"{% endif %}>
                            <i class="fas fa-plus me-1"></i>Add Cashback
                        </button>
                    </div>
                </div>

                <!-- Approval Actions -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Actions</h5>
                    </div>
                    <div class="card-body">
                        <button type="submit" name="action" value="approve" class="btn btn-success btn-block mb-2">
                            <i class="fas fa-check me-2"></i>Approve Entry
                        </button>
                        <button type="button" class="btn btn-danger btn-block" data-bs-toggle="modal" data-bs-target="#rejectModal">
                            <i class="fas fa-times me-2"></i>Reject Entry
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_approve_tracker_entry', instance_name=instance_name, entry_id=entry.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Rejection Reason (Optional):</label>
                        <textarea class="form-control" name="rejection_reason" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="action" value="reject" class="btn btn-danger">Reject Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('cashbackContainer');
    const addBtn = document.getElementById('addCashback');
    const enableCheckbox = document.getElementById('enableCashback');
    const configuredInfo = document.getElementById('configuredCashbackInfo');
    
    // Toggle cashback section based on checkbox
    function toggleCashbackSection() {
        const isEnabled = enableCheckbox.checked;
        if (container) {
            container.style.display = isEnabled ? 'block' : 'none';
        }
        if (addBtn) {
            addBtn.style.display = isEnabled ? 'block' : 'none';
        }
        // Make fields not required when disabled
        const inputs = container ? container.querySelectorAll('input') : [];
        inputs.forEach(input => {
            input.required = isEnabled;
        });
    }
    
    // Initial state
    toggleCashbackSection();
    
    // Listen for checkbox changes
    enableCheckbox.addEventListener('change', toggleCashbackSection);
    
    addBtn.addEventListener('click', function() {
        const newEntry = container.querySelector('.cashback-entry').cloneNode(true);
        // Clear username field (could be input or select)
        const usernameField = newEntry.querySelector('input[name="cashback_username[]"], select[name="cashback_username[]"]');
        if (usernameField) {
            usernameField.value = '';
        }
        // Clear points field
        const pointsField = newEntry.querySelector('input[name="cashback_points[]"]');
        if (pointsField) {
            pointsField.value = '';
        }
        // Remove any helper text
        const helperText = newEntry.querySelector('.form-text');
        if (helperText) {
            helperText.remove();
        }
        const removeBtn = newEntry.querySelector('.remove-cashback');
        if (removeBtn) {
            removeBtn.style.display = 'block';
        }
        container.appendChild(newEntry);
    });
    
    // Update remove button visibility on page load
    const entries = container.querySelectorAll('.cashback-entry');
    entries.forEach((entry, index) => {
        const removeBtn = entry.querySelector('.remove-cashback');
        if (removeBtn) {
            removeBtn.style.display = entries.length > 1 ? 'block' : 'none';
        }
    });
    
    container.addEventListener('click', function(e) {
        if (e.target.closest('.remove-cashback')) {
            const allEntries = container.querySelectorAll('.cashback-entry');
            if (allEntries.length > 1) {
                e.target.closest('.cashback-entry').remove();
                // Update remove button visibility after removal
                const remainingEntries = container.querySelectorAll('.cashback-entry');
                remainingEntries.forEach((entry, index) => {
                    const removeBtn = entry.querySelector('.remove-cashback');
                    if (removeBtn) {
                        removeBtn.style.display = remainingEntries.length > 1 ? 'block' : 'none';
                    }
                });
            }
        }
    });
});
</script>
{% endblock %}

