{% extends "base.html" %}

{% block title %}Activity Logs - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        {% include 'admin/_sidebar.html' %}

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-list-alt me-2"></i>Activity Logs</h2>
            </div>

            <!-- Today's Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Today's Logins</h5>
                            <h3>{{ today_logins }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <h5 class="card-title">Today's Logouts</h5>
                            <h3>{{ today_logouts }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Today's Payments</h5>
                            <h3>{{ today_payments }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-white" style="background: linear-gradient(135deg, #5f1e67 0%, #f5576c 100%);">
                        <div class="card-body">
                            <h5 class="card-title">Today's Cashback</h5>
                            <h3>{{ today_cashback }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Admin Actions</h5>
                            <h3>{{ today_admin_actions }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('admin_activity_logs', instance_name=instance_name) }}">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="date" class="form-label">Date Range</label>
                                <select name="date" id="date" class="form-select">
                                    <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Today</option>
                                    <option value="week" {% if date_filter == 'week' %}selected{% endif %}>Last 7 Days</option>
                                    <option value="month" {% if date_filter == 'month' %}selected{% endif %}>Last 30 Days</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="action" class="form-label">Action</label>
                                <select name="action" id="action" class="form-select">
                                    <option value="">All Actions</option>
                                    {% for action in all_actions %}
                                    <option value="{{ action }}" {% if action_filter == action %}selected{% endif %}>{{ action }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="username" class="form-label">Username</label>
                                <select name="username" id="username" class="form-select">
                                    <option value="">All Users</option>
                                    {% for username in all_usernames %}
                                    <option value="{{ username }}" {% if username_filter == username %}selected{% endif %}>{{ username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-2"></i>Filter
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Activity Logs Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Resource</th>
                                    <th>IP Address</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if logs %}
                                    {% for log in logs %}
                                    <tr>
                                        <td>
                                            {% set local_time = logging_mgr.convert_to_local_time(log.created_at) %}
                                            {{ local_time.strftime('%Y-%m-%d %H:%M:%S') if local_time else log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                            <br><small class="text-muted">({{ timezone_str }})</small>
                                        </td>
                                        <td>{{ log.username }}</td>
                                        <td>
                                            {% if log.action == 'login_success' %}
                                                <span class="badge bg-success">{{ log.action }}</span>
                                            {% elif log.action == 'login_failed' %}
                                                <span class="badge bg-danger">{{ log.action }}</span>
                                            {% elif 'payment' in log.action %}
                                                <span class="badge bg-info">{{ log.action }}</span>
                                            {% elif 'tracker' in log.action %}
                                                <span class="badge bg-primary">{{ log.action }}</span>
                                            {% elif 'cashback' in log.action %}
                                                <span class="badge" style="background: linear-gradient(135deg, #5f1e67 0%, #f5576c 100%); color: white;">{{ log.action }}</span>
                                            {% elif 'admin' in log.action %}
                                                <span class="badge bg-warning">{{ log.action }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ log.action }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if log.resource_type %}
                                                {{ log.resource_type }}:{{ log.resource_id }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ log.ip_address or '-' }}</td>
                                        <td>
                                            {% if log.details %}
                                                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ log.id }}">
                                                    View
                                                </button>
                                                <div class="collapse" id="details-{{ log.id }}">
                                                    <pre class="mt-2">{{ log.details }}</pre>
                                                </div>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No activity logs found for the selected filters.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

