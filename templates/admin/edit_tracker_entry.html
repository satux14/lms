{% extends "base.html" %}

{% block title %}Edit Entry - {{ tracker.tracker_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        {% include 'admin/_sidebar.html' %}

        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-edit me-2"></i>Edit Entry (Row {{ row_index + 1 }})
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="{{ url_for('admin_view_daily_tracker', instance_name=instance_name, tracker_id=tracker.id) }}" 
                           class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>{{ _("Back") }} to Tracker
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tracker Info Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Tracker: {{ tracker.tracker_name }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>User:</strong> {{ tracker.user.username }}
                        </div>
                        <div class="col-md-3">
                            <strong>Type:</strong> {{ tracker.tracker_type }}
                        </div>
                        <div class="col-md-3">
                            <strong>Investment:</strong> ₹{{ "%.2f"|format(tracker.investment) }}
                        </div>
                        <div class="col-md-3">
                            <strong>Start Date:</strong> {{ tracker.start_date.strftime('%Y-%m-%d') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Entry Form -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-wpforms me-2"></i>Edit Entry Details - Day {{ row_data.day }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST">
                                <!-- Day Number (editable but shown) -->
                                <div class="mb-3">
                                    <label for="day" class="form-label">
                                        <i class="fas fa-calendar-day me-2"></i>Day Number *
                                    </label>
                                    <input type="number" class="form-control" id="day" name="day" 
                                           min="0" max="{{ tracker.scheme_period }}" required
                                           value="{{ row_data.day if row_data.day is not none else '' }}">
                                    <small class="form-text text-muted">Day 0 is the start date, Day 1 is the first day after start, etc.</small>
                                </div>

                                <!-- Date (read-only, auto-calculated) -->
                                <div class="mb-3">
                                    <label for="date_display" class="form-label">
                                        <i class="fas fa-calendar me-2"></i>Date
                                    </label>
                                    <input type="text" class="form-control" id="date_display" 
                                           value="{% if row_data.date %}{% if row_data.date is string %}{{ row_data.date }}{% else %}{{ row_data.date.strftime('%Y-%m-%d') if row_data.date.strftime is defined else row_data.date }}{% endif %}{% endif %}" 
                                           readonly>
                                    <small class="form-text text-muted">Auto-calculated from start date + day number</small>
                                </div>

                                <!-- Daily Payment -->
                                <div class="mb-3">
                                    <label for="daily_payments" class="form-label">
                                        <i class="fas fa-rupee-sign me-2"></i>Daily Payment
                                    </label>
                                    <input type="number" class="form-control" id="daily_payments" name="daily_payments" 
                                           step="0.01" min="0" placeholder="e.g., 3000"
                                           value="{{ row_data.daily_payments if row_data.daily_payments is not none else '' }}">
                                </div>

                                {% if tracker.tracker_type == 'No Reinvest' %}
                                <!-- Transaction Details (No Reinvest only) -->
                                <div class="mb-3">
                                    <label for="transaction_details" class="form-label">
                                        <i class="fas fa-file-alt me-2"></i>Transaction Details
                                    </label>
                                    <input type="text" class="form-control" id="transaction_details" name="transaction_details" 
                                           placeholder="Transaction reference or details"
                                           value="{{ row_data.transaction_details if row_data.transaction_details else '' }}">
                                </div>
                                {% endif %}

                                <!-- Payment Mode -->
                                <div class="mb-3">
                                    <label for="payment_mode" class="form-label">
                                        <i class="fas fa-credit-card me-2"></i>Payment Mode
                                    </label>
                                    <select class="form-select" id="payment_mode" name="payment_mode">
                                        <option value="">Select payment mode...</option>
                                        <option value="Cash" {% if row_data.payment_mode == 'Cash' %}selected{% endif %}>Cash</option>
                                        <option value="Bank Transfer" {% if row_data.payment_mode == 'Bank Transfer' %}selected{% endif %}>Bank Transfer</option>
                                        <option value="UPI" {% if row_data.payment_mode == 'UPI' %}selected{% endif %}>UPI</option>
                                        <option value="Cheque" {% if row_data.payment_mode == 'Cheque' %}selected{% endif %}>Cheque</option>
                                        <option value="Online" {% if row_data.payment_mode == 'Online' %}selected{% endif %}>Online</option>
                                        <option value="Other" {% if row_data.payment_mode == 'Other' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>


                                {% if tracker.tracker_type == '1L' %}
                                <!-- 1L Enhanced specific fields -->
                                <div class="mb-3">
                                    <label for="reinvest" class="form-label">
                                        <i class="fas fa-redo me-2"></i>Reinvest Amount
                                    </label>
                                    <input type="number" class="form-control" id="reinvest" name="reinvest" 
                                           step="0.01" min="0" placeholder="Amount to reinvest"
                                           value="{{ row_data.reinvest if row_data.reinvest is not none else '' }}">
                                </div>

                                <div class="mb-3">
                                    <label for="reinvest_from" class="form-label">
                                        <i class="fas fa-info-circle me-2"></i>Reinvest From
                                    </label>
                                    <input type="text" class="form-control" id="reinvest_from" name="reinvest_from" 
                                           placeholder="Source of reinvestment"
                                           value="{{ row_data.reinvest_from if row_data.reinvest_from else '' }}">
                                </div>

                                <div class="mb-3">
                                    <label for="pocket_money" class="form-label">
                                        <i class="fas fa-wallet me-2"></i>Pocket Money
                                    </label>
                                    <input type="number" class="form-control" id="pocket_money" name="pocket_money" 
                                           step="0.01" min="0" placeholder="Pocket money amount"
                                           value="{{ row_data.pocket_money if row_data.pocket_money is not none else '' }}">
                                </div>
                                {% endif %}

                                <!-- Notes -->
                                <div class="mb-3">
                                    <label for="notes" class="form-label">
                                        <i class="fas fa-sticky-note me-2"></i>Notes
                                    </label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" 
                                              placeholder="Any additional notes or comments">{{ row_data.notes if row_data.notes else '' }}</textarea>
                                </div>

                                <!-- Cashback Points Section -->
                                <div class="card mt-4 border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-coins me-2"></i>Cashback Points (Optional)</h6>
                                    </div>
                                    <div class="card-body">
                                        {% if configured_cashback %}
                                        <div class="alert alert-warning mb-3" id="configuredCashbackAlert">
                                            <i class="fas fa-cog me-2"></i>
                                            <strong>Configured Cashback (from tracker config):</strong>
                                            <ul class="mb-0 mt-2" id="configuredCashbackList">
                                                {% for cb in configured_cashback %}
                                                <li data-username="{{ cb.username }}" data-type="{{ cb.config_type }}" data-value="{{ cb.config_value }}">
                                                    <strong>{{ cb.username }}</strong>: ₹<span class="calculated-points">{{ "%.2f"|format(cb.points) }}</span>
                                                    {% if cb.config_type == 'percentage' %}
                                                        <small class="text-muted">
                                                            (<span class="daily-payment-display">{{ "%.2f"|format(cb.daily_payment_used) }}</span> × {{ "%.4f"|format(cb.config_value * 100) }}% = ₹<span class="calculated-points">{{ "%.2f"|format(cb.points) }}</span>)
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">(Fixed: ₹{{ "%.2f"|format(cb.config_value) }})</small>
                                                    {% endif %}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                            <small class="text-danger d-block mt-2" id="zeroPaymentWarning" style="display: {% if row_data.daily_payments and row_data.daily_payments != 0 %}none{% else %}block{% endif %};">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                Note: Daily payment is ₹0.00 for this entry. Cashback will be calculated when a payment amount is entered.
                                            </small>
                                        </div>
                                        {% endif %}
                                        
                                        {% if existing_cashback %}
                                        <div class="alert alert-info mb-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Existing Cashback:</strong> This entry already has cashback assigned. You can add more users below.
                                            <ul class="mb-0 mt-2">
                                                {% for cb in existing_cashback %}
                                                <li>
                                                    <strong>{{ cb.user.username }}</strong>: ₹{{ "%.2f"|format(cb.points) }}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% else %}
                                        {% if not configured_cashback %}
                                        <p class="text-muted small mb-3">
                                            Add cashback points to users for this tracker entry.
                                        </p>
                                        {% endif %}
                                        
                                        {% if templates %}
                                        <!-- Quick Add Templates -->
                                        <div class="card bg-light mb-3">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Add Templates</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <p class="text-muted small mb-0">Quickly add common cashback configurations.</p>
                                                    <button type="button" class="btn btn-success btn-sm" id="addAllTemplatesBtn">
                                                        <i class="fas fa-plus-circle me-1"></i>Add All
                                                    </button>
                                                </div>
                                                <div class="row">
                                                    {% for template_key, template in templates.items() %}
                                                    <div class="col-md-4 mb-2">
                                                        <div class="card border-primary">
                                                            <div class="card-body p-2">
                                                                <div class="mb-1">
                                                                    <label class="form-label small text-muted">Username</label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-sm template-username" 
                                                                           data-template="{{ template_key }}"
                                                                           value="{{ template.username }}"
                                                                           placeholder="Enter username">
                                                                </div>
                                                                
                                                                <div class="mb-1">
                                                                    <label class="form-label small text-muted">Percentage</label>
                                                                    <div class="input-group input-group-sm">
                                                                        <input type="number" 
                                                                               class="form-control template-percentage" 
                                                                               data-template="{{ template_key }}"
                                                                               value="{{ template.percentage }}"
                                                                               step="0.01" 
                                                                               min="0.01" 
                                                                               max="100"
                                                                               placeholder="5">
                                                                        <span class="input-group-text">%</span>
                                                                    </div>
                                                                </div>
                                                                
                                                                <button type="button" class="btn btn-primary btn-sm w-100 add-template-btn" data-template="{{ template_key }}">
                                                                    <i class="fas fa-plus me-1"></i>Add
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                        
                                        <div id="cashbackUsersContainer">
                                            {% if existing_cashback %}
                                                {% for cb in existing_cashback %}
                                                <div class="cashback-user-entry mb-3 p-3 border rounded">
                                                    <div class="row">
                                                        <div class="col-md-5 mb-2">
                                                            <label class="form-label small">Username</label>
                                                            {% if is_admin and all_users %}
                                                            <select class="form-select form-select-sm" name="cashback_username[]" required>
                                                                <option value="">Select a user...</option>
                                                                {% for user in all_users %}
                                                                <option value="{{ user.username }}" {% if user.username == cb.user.username %}selected{% endif %}>{{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}</option>
                                                                {% endfor %}
                                                            </select>
                                                            {% else %}
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   name="cashback_username[]" 
                                                                   value="{{ cb.user.username }}" 
                                                                   placeholder="Enter username" required>
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-md-5 mb-2">
                                                            <label class="form-label small">Points</label>
                                                            <input type="number" class="form-control form-control-sm cashback-points-input" 
                                                                   name="cashback_points[]" 
                                                                   step="0.01" min="0" 
                                                                   value="{{ "%.2f"|format(cb.points) }}" 
                                                                   placeholder="0.00">
                                                        </div>
                                                        <div class="col-md-2 mb-2 d-flex align-items-end">
                                                            <button type="button" class="btn btn-danger btn-sm w-100 remove-cashback-user">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% elif configured_cashback %}
                                                {% for cb in configured_cashback %}
                                                <div class="cashback-user-entry mb-3 p-3 border rounded">
                                                    <div class="row">
                                                        <div class="col-md-5 mb-2">
                                                            <label class="form-label small">Username</label>
                                                            {% if is_admin and all_users %}
                                                            <select class="form-select form-select-sm" name="cashback_username[]" required>
                                                                <option value="">Select a user...</option>
                                                                {% for user in all_users %}
                                                                <option value="{{ user.username }}" {% if user.username == cb.username %}selected{% endif %}>{{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}</option>
                                                                {% endfor %}
                                                            </select>
                                                            {% else %}
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   name="cashback_username[]" 
                                                                   value="{{ cb.username }}" 
                                                                   placeholder="Enter username" required>
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-md-5 mb-2">
                                                            <label class="form-label small">Points</label>
                                                            <input type="number" class="form-control form-control-sm" 
                                                                   name="cashback_points[]" 
                                                                   step="0.01" min="0.01" 
                                                                   value="{{ "%.2f"|format(cb.points) }}" 
                                                                   placeholder="0.00" required>
                                                        </div>
                                                        <div class="col-md-2 mb-2 d-flex align-items-end">
                                                            <button type="button" class="btn btn-danger btn-sm w-100 remove-cashback-user">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="cashback-user-entry mb-3 p-3 border rounded">
                                                    <div class="row">
                                                        <div class="col-md-5 mb-2">
                                                            <label class="form-label small">Username</label>
                                                            {% if is_admin and all_users %}
                                                            <select class="form-select form-select-sm" name="cashback_username[]">
                                                                <option value="">Select a user...</option>
                                                                {% for user in all_users %}
                                                                <option value="{{ user.username }}">{{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}</option>
                                                                {% endfor %}
                                                            </select>
                                                            {% else %}
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   name="cashback_username[]" placeholder="Enter username">
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-md-5 mb-2">
                                                            <label class="form-label small">Points</label>
                                                            <input type="number" class="form-control form-control-sm cashback-points-input" 
                                                                   name="cashback_points[]" step="0.01" min="0" placeholder="0.00">
                                                        </div>
                                                        <div class="col-md-2 mb-2 d-flex align-items-end">
                                                            <button type="button" class="btn btn-danger btn-sm w-100 remove-cashback-user">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="addCashbackUserBtn">
                                            <i class="fas fa-plus me-2"></i>Add Another User
                                        </button>
                                        <small class="form-text text-muted d-block mt-2">
                                            <i class="fas fa-lightbulb me-1"></i>
                                            Tip: You can modify existing cashback amounts or add new users. All changes will be saved when you update the entry.
                                        </small>
                                    </div>
                                </div>

                                <!-- Submit Buttons -->
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{{ url_for('admin_view_daily_tracker', instance_name=instance_name, tracker_id=tracker.id) }}" 
                                       class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Update Entry
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Info Sidebar -->
                <div class="col-lg-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Editing Entry
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6><i class="fas fa-info-circle me-2 text-info"></i>Current Values</h6>
                            <ul class="small">
                                <li><strong>Day:</strong> {{ row_data.day }}</li>
                                <li><strong>Date:</strong> {% if row_data.date %}{% if row_data.date is string %}{{ row_data.date }}{% else %}{{ row_data.date.strftime('%Y-%m-%d') }}{% endif %}{% else %}Not set{% endif %}</li>
                                <li><strong>Payment:</strong> ₹{{ "%.2f"|format(row_data.daily_payments) if row_data.daily_payments is not none else '0.00' }}</li>
                                <li><strong>Mode:</strong> {{ row_data.payment_mode if row_data.payment_mode else 'Not set' }}</li>
                                {% if tracker.tracker_type in ['50K', '1L', 'No Reinvest'] %}
                                <li><strong>Cumulative:</strong> ₹{{ "%.2f"|format(row_data.cumulative) if row_data.cumulative is not none else '0.00' }}</li>
                                {% endif %}
                            </ul>

                            <hr>

                            <h6><i class="fas fa-lightbulb me-2 text-warning"></i>Tips</h6>
                            <ul class="small">
                                <li>You're editing row {{ row_index + 1 }} of the tracker</li>
                                <li>All current values are pre-filled</li>
                                <li>Leave a field empty to clear its value</li>
                                <li>Excel formulas will auto-recalculate</li>
                                <li>Changes are saved immediately to the Excel file</li>
                            </ul>

                            <hr>

                            <div class="alert alert-info small">
                                <i class="fas fa-shield-alt me-2"></i>
                                This edit button allows you to update specific entries without confusion, 
                                even if there are duplicate day numbers in the tracker.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Configured cashback calculation
const dailyPaymentsInput = document.getElementById('daily_payments');
const configuredCashbackList = document.getElementById('configuredCashbackList');

if (dailyPaymentsInput && configuredCashbackList) {
    function recalculateConfiguredCashback() {
        const dailyPayment = parseFloat(dailyPaymentsInput.value) || 0;
        const warningMsg = document.getElementById('zeroPaymentWarning');
        
        if (warningMsg) {
            warningMsg.style.display = dailyPayment === 0 ? 'block' : 'none';
        }
        
        // Update each configured cashback entry
        configuredCashbackList.querySelectorAll('li').forEach(item => {
            const configType = item.getAttribute('data-type');
            const configValue = parseFloat(item.getAttribute('data-value')) || 0;
            const username = item.getAttribute('data-username');
            
            let points = 0;
            if (configType === 'percentage') {
                points = dailyPayment * configValue;
            } else {
                points = configValue; // fixed
            }
            
            // Round to 2 decimal places
            points = Math.round(points * 100) / 100;
            
            // Update displayed values
            item.querySelectorAll('.calculated-points').forEach(span => {
                span.textContent = points.toFixed(2);
            });
            
            // Update daily payment display in calculation
            const dailyPaymentDisplay = item.querySelector('.daily-payment-display');
            if (dailyPaymentDisplay) {
                dailyPaymentDisplay.textContent = dailyPayment.toFixed(2);
            }
            
            // Update pre-filled input field if it exists
            const cashbackInputs = document.querySelectorAll('input[name="cashback_username[]"]');
            cashbackInputs.forEach((input, index) => {
                if (input.value === username) {
                    const pointsInput = input.closest('.cashback-user-entry').querySelector('input[name="cashback_points[]"]');
                    if (pointsInput) {
                        pointsInput.value = points.toFixed(2);
                    }
                }
            });
        });
    }
    
    // Recalculate when daily payment changes
    dailyPaymentsInput.addEventListener('input', recalculateConfiguredCashback);
    dailyPaymentsInput.addEventListener('change', recalculateConfiguredCashback);
    
    // Update points field validation based on daily payment
    function updatePointsFieldValidation() {
        const dailyPayment = parseFloat(dailyPaymentsInput.value) || 0;
        const pointsInputs = document.querySelectorAll('.cashback-points-input');
        pointsInputs.forEach(input => {
            if (dailyPayment === 0) {
                input.removeAttribute('required');
                input.setAttribute('min', '0');
            } else {
                // Keep optional but allow 0
                input.removeAttribute('required');
                input.setAttribute('min', '0');
            }
        });
    }
    
    dailyPaymentsInput.addEventListener('input', updatePointsFieldValidation);
    dailyPaymentsInput.addEventListener('change', updatePointsFieldValidation);
    
    // Initial calculation
    recalculateConfiguredCashback();
    updatePointsFieldValidation();
}

// Cashback user management
const cashbackContainer = document.getElementById('cashbackUsersContainer');
const addCashbackBtn = document.getElementById('addCashbackUserBtn');

// Show remove buttons - always show delete button
function updateRemoveButtons() {
    const entries = cashbackContainer.querySelectorAll('.cashback-user-entry');
    entries.forEach((entry) => {
        const removeBtn = entry.querySelector('.remove-cashback-user');
        // Always show delete button
        removeBtn.style.display = 'block';
    });
}

// Initialize remove buttons visibility
updateRemoveButtons();

if (addCashbackBtn) {
    addCashbackBtn.addEventListener('click', function() {
        const templateEntry = cashbackContainer.querySelector('.cashback-user-entry');
        if (!templateEntry) {
            console.error('No template entry found');
            return;
        }
        
        const newEntry = templateEntry.cloneNode(true);
        
        // Clear username field (handle both select and input)
        const usernameField = newEntry.querySelector('input[name="cashback_username[]"], select[name="cashback_username[]"]');
        if (usernameField) {
            usernameField.value = '';
        } else {
            console.warn('Username field not found in cloned entry');
        }
        
        // Clear points field
        const pointsField = newEntry.querySelector('input[name="cashback_points[]"]');
        if (pointsField) {
            pointsField.value = '';
        } else {
            console.warn('Points field not found in cloned entry');
        }
        
        cashbackContainer.appendChild(newEntry);
        updateRemoveButtons();
    });
}

document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-cashback-user')) {
        const container = document.getElementById('cashbackUsersContainer');
        // Allow deletion even if only one entry exists
        e.target.closest('.cashback-user-entry').remove();
        updateRemoveButtons();
    }
});

// Helper function to check if username exists
async function checkUsernameExists(username) {
    try {
        const response = await fetch('{{ url_for("api_check_username", instance_name=instance_name) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: username })
        });
        const data = await response.json();
        return data.success && data.exists;
    } catch (error) {
        console.error('Error checking username:', error);
        return false;
    }
}

// Template functionality
{% if templates %}
document.querySelectorAll('.add-template-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const templateKey = this.getAttribute('data-template');
        const usernameInput = document.querySelector(`.template-username[data-template="${templateKey}"]`);
        const percentageInput = document.querySelector(`.template-percentage[data-template="${templateKey}"]`);
        
        const username = usernameInput.value.trim();
        const percentage = parseFloat(percentageInput.value);
        const dailyPayment = parseFloat(document.getElementById('daily_payments').value) || 0;
        
        if (!username || isNaN(percentage) || percentage <= 0) {
            alert('Please enter valid username and percentage');
            return;
        }
        
        // Check if username exists
        const exists = await checkUsernameExists(username);
        if (!exists) {
            alert(`User "${username}" does not exist in the system. Please check the username and try again.`);
            return;
        }
        
        // Calculate points based on percentage of daily payment
        const points = dailyPayment > 0 ? (dailyPayment * percentage / 100) : 0;
        
            // Add to cashback container
            const newEntry = document.createElement('div');
            newEntry.className = 'cashback-user-entry mb-3 p-3 border rounded';
            
            {% if is_admin and all_users %}
            // Build select dropdown for admin
            let usernameOptions = '<option value="">Select a user...</option>';
            {% for user in all_users %}
            usernameOptions += '<option value="{{ user.username }}"' + (username === '{{ user.username }}' ? ' selected' : '') + '>{{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}</option>';
            {% endfor %}
            const usernameField = '<select class="form-select form-select-sm" name="cashback_username[]" required>' + usernameOptions + '</select>';
            {% else %}
            const usernameField = '<input type="text" class="form-control form-control-sm" name="cashback_username[]" value="' + username + '" placeholder="Enter username" required>';
            {% endif %}
            
            newEntry.innerHTML = `
                <div class="row">
                    <div class="col-md-5 mb-2">
                        <label class="form-label small">Username</label>
                        ${usernameField}
                    </div>
                <div class="col-md-5 mb-2">
                    <label class="form-label small">Points</label>
                    <input type="number" class="form-control form-control-sm cashback-points-input" 
                           name="cashback_points[]" 
                           step="0.01" min="0" 
                           value="${points.toFixed(2)}" 
                           placeholder="0.00">
                </div>
                <div class="col-md-2 mb-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm w-100 remove-cashback-user">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        cashbackContainer.appendChild(newEntry);
        updateRemoveButtons();
    });
});

// Add All Templates functionality
const addAllBtn = document.getElementById('addAllTemplatesBtn');
if (addAllBtn) {
    addAllBtn.addEventListener('click', async function() {
        const templates = document.querySelectorAll('.add-template-btn');
        const invalidUsers = [];
        
        // Validate all usernames first
        for (const btn of templates) {
            const templateKey = btn.getAttribute('data-template');
            const usernameInput = document.querySelector(`.template-username[data-template="${templateKey}"]`);
            const username = usernameInput.value.trim();
            
            if (username) {
                const exists = await checkUsernameExists(username);
                if (!exists) {
                    invalidUsers.push(username);
                }
            }
        }
        
        if (invalidUsers.length > 0) {
            alert(`The following users do not exist in the system:\n${invalidUsers.join(', ')}\n\nPlease correct the usernames before adding.`);
            return;
        }
        
        // All users are valid, add them
        templates.forEach(btn => {
            btn.click();
        });
    });
}
{% endif %}

// Auto-update date display when day changes
document.getElementById('day').addEventListener('change', function() {
    const day = parseInt(this.value);
    const startDate = new Date('{{ tracker.start_date.strftime("%Y-%m-%d") }}');
    const targetDate = new Date(startDate);
    targetDate.setDate(startDate.getDate() + (day - 1));
    
    const year = targetDate.getFullYear();
    const month = String(targetDate.getMonth() + 1).padStart(2, '0');
    const date = String(targetDate.getDate()).padStart(2, '0');
    
    document.getElementById('date_display').value = `${year}-${month}-${date}`;
});
</script>
{% endblock %}

