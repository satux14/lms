{% extends "base.html" %}

{% block title %}Tracker Cashback Config - {{ _('The SRS Consulting') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        {% include 'admin/_sidebar.html' %}
        
        <!-- Main content -->
        <div class="col-md-9 col-lg-10 main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-coins me-2"></i>Cashback Configuration: {{ tracker.tracker_name }}
                </h1>
                <div>
                    <a href="{{ url_for('admin_view_daily_tracker', instance_name=instance_name, tracker_id=tracker.id) }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Tracker
                    </a>
                </div>
            </div>

            <!-- Tracker Info -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="mb-3">Tracker Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Tracker Name:</strong> {{ tracker.tracker_name }}</p>
                                    <p><strong>Customer:</strong> {{ tracker.user.username }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Per Day Payment:</strong> ₹{{ "%.2f"|format(tracker.per_day_payment) }}</p>
                                    <p><strong>Total Days:</strong> {{ tracker.total_days }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Add Templates -->
            {% if templates %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Add Templates</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <p class="text-muted mb-0">Quickly add common cashback configurations. Edit username and percentage before adding.</p>
                                <button type="button" class="btn btn-success btn-sm" id="addAllTemplatesBtn">
                                    <i class="fas fa-plus-circle me-1"></i>Add All Templates
                                </button>
                            </div>
                            <div class="row">
                                {% for template_key, template in templates.items() %}
                                <div class="col-md-4 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <label class="form-label small text-muted">Username</label>
                                                <input type="text" 
                                                       class="form-control form-control-sm template-username" 
                                                       data-template="{{ template_key }}"
                                                       value="{{ template.username }}"
                                                       placeholder="Enter username">
                                            </div>
                                            
                                            <div class="mb-2">
                                                <label class="form-label small text-muted">Percentage</label>
                                                <div class="input-group input-group-sm">
                                                    <input type="number" 
                                                           class="form-control template-percentage" 
                                                           data-template="{{ template_key }}"
                                                           value="{{ template.percentage }}"
                                                           step="0.01" 
                                                           min="0.01" 
                                                           max="100"
                                                           placeholder="5">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            
                                            <button type="button" class="btn btn-primary btn-sm w-100 add-template-btn" data-template="{{ template_key }}">
                                                <i class="fas fa-plus me-1"></i>Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Configure Automatic Cashback</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div id="configContainer">
                            {% if cashback_configs %}
                                {% for config in cashback_configs %}
                                <div class="config-entry mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Username</label>
                                            {% if is_admin and all_users %}
                                            <select class="form-select" name="username[]" required>
                                                <option value="">Select a user...</option>
                                                {% for user in all_users %}
                                                <option value="{{ user.username }}" {% if user.username == config.user.username %}selected{% endif %}>{{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}</option>
                                                {% endfor %}
                                            </select>
                                            {% else %}
                                            <input type="text" class="form-control" name="username[]" value="{{ config.user.username }}" required>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Type</label>
                                            <select class="form-select" name="cashback_type[]" required>
                                                <option value="percentage" {% if config.cashback_type == 'percentage' %}selected{% endif %}>Percentage</option>
                                                <option value="fixed" {% if config.cashback_type == 'fixed' %}selected{% endif %}>Fixed Amount</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Value</label>
                                            <input type="number" step="0.0001" class="form-control" name="cashback_value[]" value="{{ config.cashback_value }}" required>
                                            <small class="form-text text-muted">
                                                {% if config.cashback_type == 'percentage' %}
                                                    (e.g., 0.05 for 5%)
                                                {% else %}
                                                    Fixed amount in ₹
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-danger btn-sm w-100 remove-config" data-config-id="{{ config.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <input type="hidden" name="delete_config[]" value="{{ config.id }}" class="delete-config-input" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="config-entry mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Username</label>
                                            {% if is_admin and all_users %}
                                            <select class="form-select" name="username[]" required>
                                                <option value="">Select a user...</option>
                                                {% for user in all_users %}
                                                <option value="{{ user.username }}">{{ user.username }}{% if user.email %} ({{ user.email }}){% endif %}</option>
                                                {% endfor %}
                                            </select>
                                            {% else %}
                                            <input type="text" class="form-control" name="username[]" required>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Type</label>
                                            <select class="form-select" name="cashback_type[]" required>
                                                <option value="percentage">Percentage</option>
                                                <option value="fixed">Fixed Amount</option>
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label">Value</label>
                                            <input type="number" step="0.0001" class="form-control" name="cashback_value[]" required>
                                            <small class="form-text text-muted">For percentage: e.g., 0.05 for 5%</small>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-secondary" id="addConfig">
                            <i class="fas fa-plus me-1"></i>Add Configuration
                        </button>
                        
                        <hr>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Configuration
                        </button>
                    </form>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('configContainer');
    const addBtn = document.getElementById('addConfig');
    
    addBtn.addEventListener('click', function() {
        const templateEntry = container.querySelector('.config-entry');
        if (!templateEntry) return;
        
        const newEntry = templateEntry.cloneNode(true);
        const usernameField = newEntry.querySelector('input[name="username[]"], select[name="username[]"]');
        if (usernameField) {
            if (usernameField.tagName === 'SELECT') {
                usernameField.value = '';
            } else {
                usernameField.value = '';
            }
        }
        newEntry.querySelector('select[name="cashback_type[]"]').value = 'percentage';
        newEntry.querySelector('input[name="cashback_value[]"]').value = '';
        
        // Remove delete input if it exists (for new entries)
        const deleteInput = newEntry.querySelector('.delete-config-input');
        if (deleteInput) {
            deleteInput.remove();
        }
        
        // Ensure remove button has no config-id (new entry)
        const removeBtn = newEntry.querySelector('.remove-config');
        if (removeBtn) {
            removeBtn.setAttribute('data-config-id', '');
        }
        
        // Show the entry if it was hidden
        newEntry.style.display = '';
        
        container.appendChild(newEntry);
    });
    
    // Helper function to check if username exists
    async function checkUsernameExists(username) {
        try {
            const response = await fetch('{{ url_for("api_check_username", instance_name=instance_name) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: username })
            });
            const data = await response.json();
            return data.success && data.exists;
        } catch (error) {
            console.error('Error checking username:', error);
            return false;
        }
    }
    
    // Add template functionality
    {% if templates %}
    document.querySelectorAll('.add-template-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const templateKey = this.getAttribute('data-template');
            const usernameInput = document.querySelector(`.template-username[data-template="${templateKey}"]`);
            const percentageInput = document.querySelector(`.template-percentage[data-template="${templateKey}"]`);
            
            const username = usernameInput.value.trim();
            const percentage = parseFloat(percentageInput.value);
            
            if (!username || isNaN(percentage) || percentage <= 0) {
                alert('Please enter valid username and percentage');
                return;
            }
            
            // Check if username exists
            const exists = await checkUsernameExists(username);
            if (!exists) {
                alert(`User "${username}" does not exist in the system. Please check the username and try again.`);
                return;
            }
            
            // Add to config container
            const newEntry = document.createElement('div');
            newEntry.className = 'config-entry mb-3 p-3 border rounded';
            newEntry.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" name="username[]" value="${username}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" name="cashback_type[]" required>
                            <option value="percentage" selected>Percentage</option>
                            <option value="fixed">Fixed Amount</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Value</label>
                        <input type="number" step="0.0001" class="form-control" name="cashback_value[]" value="${(percentage / 100).toFixed(4)}" required>
                        <small class="form-text text-muted">(e.g., ${(percentage / 100).toFixed(4)} for ${percentage}%)</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm w-100 remove-config">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(newEntry);
            
            // Add remove functionality
            newEntry.querySelector('.remove-config').addEventListener('click', function() {
                newEntry.remove();
            });
        });
    });
    
    // Add All Templates functionality
    const addAllBtn = document.getElementById('addAllTemplatesBtn');
    if (addAllBtn) {
        addAllBtn.addEventListener('click', async function() {
            const templates = document.querySelectorAll('.add-template-btn');
            const invalidUsers = [];
            
            // Validate all usernames first
            for (const btn of templates) {
                const templateKey = btn.getAttribute('data-template');
                const usernameInput = document.querySelector(`.template-username[data-template="${templateKey}"]`);
                const username = usernameInput.value.trim();
                
                if (username) {
                    const exists = await checkUsernameExists(username);
                    if (!exists) {
                        invalidUsers.push(username);
                    }
                }
            }
            
            if (invalidUsers.length > 0) {
                alert(`The following users do not exist in the system:\n${invalidUsers.join(', ')}\n\nPlease correct the usernames before adding.`);
                return;
            }
            
            // All users are valid, add them
            templates.forEach(btn => {
                btn.click();
            });
        });
    }
    {% endif %}
    
    // Remove config functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-config')) {
            const removeBtn = e.target.closest('.remove-config');
            const configEntry = removeBtn.closest('.config-entry');
            const configId = removeBtn.getAttribute('data-config-id');
            
            if (configId) {
                // Existing config - mark for deletion by showing the hidden input
                const deleteInput = configEntry.querySelector('.delete-config-input');
                if (deleteInput) {
                    deleteInput.style.display = 'block';
                    deleteInput.value = configId;
                }
                // Hide the entry visually
                configEntry.style.display = 'none';
            } else {
                // New config - just remove it
                configEntry.remove();
            }
        }
    });
});
</script>
{% endblock %}

