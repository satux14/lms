{% extends "base.html" %}

{% block title %}{{ _('Loan Details') }} - {{ _('The SRS Consulting') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-file-invoice-dollar me-2"></i>{{ loan.loan_name }} {{ _('Details') }}
                </h1>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('customer_all_loans', instance_name=instance_name) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>{{ _("Back") }} to All Loans
                    </a>
                </div>
            </div>

            <!-- Loan Information -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>{{ _('Loan Information') }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>{{ _('Loan ID') }}:</strong></td>
                                            <td>#{{ loan.id }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Loan Name') }}:</strong></td>
                                            <td>{{ loan.loan_name }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Status') }}:</strong></td>
                                            <td>
                                                {% if loan.is_active %}
                                                    <span class="badge bg-success">{{ _('Active') }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ _('Inactive') }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Loan Type') }}:</strong></td>
                                            <td>
                                                <span class="badge bg-{{ 'primary' if loan.loan_type == 'regular' else 'info' }}">
                                                    {% if loan.loan_type == 'regular' %}{{ _('Regular Loan') }}{% else %}{{ _('Interest-Only Loan') }}{% endif %}
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>{{ _('Original Principal') }}:</strong></td>
                                            <td class="text-primary">₹{{ "%.2f"|format(loan.principal_amount) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Remaining Balance') }}:</strong></td>
                                            <td class="text-warning">₹{{ "%.2f"|format(loan.remaining_principal) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Interest Rate') }}:</strong></td>
                                            <td>{{ "%.2f"|format(loan.interest_rate * 100) }}% {{ _('Annual') }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Payment Frequency') }}:</strong></td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if loan.payment_frequency == 'daily' else 'warning' }}">
                                                    {{ loan.payment_frequency.title() }}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Created Date') }}:</strong></td>
                                            <td>{{ loan.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>{{ _('Days Active') }}:</strong></td>
                                            <td>{{ days_active }} {{ _('days') }}</td>
                                        </tr>
                                        {% if loan_cashback_total > 0 %}
                                        <tr>
                                            <td><strong>{{ _('Cashback') }}:</strong></td>
                                            <td style="color: #5f1e67;">
                                                <i class="fas fa-coins me-1"></i>₹{{ "%.2f"|format(loan_cashback_total) }}
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>{{ _('Summary') }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-{% if loan_cashback_total > 0 %}3{% else %}4{% endif %}">
                                    <h6 class="text-muted">{{ _('Monthly Interest') }}</h6>
                                    <h4 class="text-warning">₹{{ "%.2f"|format(monthly_interest) }}</h4>
                                </div>
                                <div class="col-md-{% if loan_cashback_total > 0 %}3{% else %}4{% endif %}">
                                    <h6 class="text-muted">{{ _('Interest Pending Monthly') }}</h6>
                                    <h4 class="{% if accumulated_interest_monthly > 0 %}text-danger{% else %}text-success{% endif %}">₹{{ "%.2f"|format(accumulated_interest_monthly) }}</h4>
                                </div>
                                {% if loan_cashback_total > 0 %}
                                <div class="col-md-3">
                                    <h6 class="text-muted">{{ _('Cashback') }}</h6>
                                    <h4 style="color: #5f1e67;">
                                        <i class="fas fa-coins me-1"></i>₹{{ "%.2f"|format(loan_cashback_total) }}
                                    </h4>
                                </div>
                                {% endif %}
                            </div>
                            {% if pending_total > 0 %}
                            <hr>
                            <div class="alert alert-warning">
                                <h6 class="alert-heading">
                                    <i class="fas fa-clock me-1"></i>{{ _('Pending Payments') }}
                                </h6>
                                <p class="mb-1">
                                    <strong>{{ _('Total Pending') }}:</strong> ₹{{ "%.2f"|format(pending_total) }}<br>
                                    <strong>{{ _('Principal') }}:</strong> ₹{{ "%.2f"|format(pending_principal) }}<br>
                                    <strong>{{ _('Interest') }}:</strong> ₹{{ "%.2f"|format(pending_interest) }}
                                </p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Make Payment -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>{{ _('Make Payment') }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('customer_make_payment', instance_name=instance_name, loan_id=loan.id) }}" enctype="multipart/form-data" id="manual-payment-form">
                                <div class="mb-3">
                                    <label for="amount" class="form-label">{{ _('Payment Amount') }}</label>
                                    <div class="input-group">
                                        <span class="input-group-text">₹</span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="amount" 
                                               name="amount" 
                                               step="0.01" 
                                               min="0.01" 
                                               {% if loan.loan_type == 'interest_only' %}
                                               {% if accumulated_interest_monthly > 0 %}
                                               max="{{ accumulated_interest_monthly }}"
                                               {% else %}
                                               max="0.01"
                                               disabled
                                               {% endif %}
                                               {% else %}
                                               max="{{ loan.remaining_principal }}"
                                               {% endif %}
                                               required>
                                    </div>
                                    <div class="form-text">
                                        {% if loan.loan_type == 'interest_only' %}
                                            {% if accumulated_interest_monthly > 0 %}
                                                <strong>{{ _('Interest-Only Loan:') }}</strong> {{ _('You can only pay interest') }} (₹{{ "%.2f"|format(accumulated_interest_monthly) }} {{ _('accumulated') }})
                                            {% else %}
                                                <strong>{{ _('Interest-Only Loan:') }}</strong> {{ _('No interest pending. All interest has been paid.') }}
                                            {% endif %}
                                        {% else %}
                                            {{ _('Maximum:') }} ₹{{ "%.2f"|format(loan.remaining_principal) }}
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="payment_method" class="form-label">{{ _('Payment Method') }}</label>
                                    <select class="form-select" id="payment_method" name="payment_method" required>
                                        <option value="">{{ _('Select payment method...') }}</option>
                                        <option value="gpay">Google Pay (GPay)</option>
                                        <option value="upi">UPI</option>
                                        <option value="phonepay">PhonePe</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="cash">Cash</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="transaction_id" class="form-label">{{ _('Transaction ID / UPI Reference') }}</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="transaction_id" 
                                           name="transaction_id" 
                                           placeholder="e.g., UPI123456789 or TXN987654321">
                                    <div class="form-text">
                                        {{ _('Enter your UPI transaction ID or bank reference number') }}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="proof_file" class="form-label">{{ _('Payment Proof (Optional)') }}</label>
                                    <input type="file"
                                           class="form-control"
                                           id="proof_file"
                                           name="proof_file"
                                           accept=".jpg,.jpeg,.png,.gif,.pdf">
                                    <div class="form-text">
                                        {{ _('Upload screenshot of payment confirmation (JPEG, PNG, GIF, PDF - Max 16MB)') }}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="payment_date" class="form-label">{{ _('Payment Date & Time (Optional)') }}</label>
                                    <input type="datetime-local"
                                           class="form-control"
                                           id="payment_date"
                                           name="payment_date">
                                    <div class="form-text">
                                        {{ _('Leave empty to use current date/time, or select when payment was actually made') }}
                                    </div>
                                </div>

                                <div class="d-grid">
                                    {% if loan.loan_type == 'interest_only' and accumulated_interest_monthly <= 0 %}
                                        <button type="button" class="btn btn-secondary btn-lg" disabled>
                                            <i class="fas fa-check me-2"></i>{{ _('No Payment Required') }}
                                        </button>
                                    {% else %}
                                        <button type="submit" class="btn btn-success btn-lg">
                                            <i class="fas fa-credit-card me-2"></i>{{ _('Make Payment') }}
                                        </button>
                                    {% endif %}
                                </div>
                            </form>

                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% if loan.loan_type == 'interest_only' %}
                                        <strong>{{ _('Interest-Only Loan:') }}</strong> {{ _('You can only pay interest') }}. {{ _('Principal amount remains fixed until loan closure.') }}
                                    {% else %}
                                        {{ _('Payments above the interest amount will reduce your principal balance.') }}
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>{{ _('Payment History') }}
                            </h5>
                            <span class="badge bg-primary">{{ payments|length }} {{ _('payments') }}</span>
                        </div>
                        <div class="card-body">
                            {% if payments %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>{{ _('Date') }}</th>
                                            <th>{{ _('Amount') }}</th>
                                            <th>{{ _('Interest') }}</th>
                                            <th>{{ _('Principal') }}</th>
                                            <th>{{ _('Method') }}</th>
                                            <th>{{ _('Transaction ID') }}</th>
                                            <th>{{ _('Status') }}</th>
                                            {% if has_any_cashback %}
                                            <th>{{ _('Cashback') }}</th>
                                            {% endif %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment_data in payments %}
                                        {% set payment = payment_data.payment %}
                                        <tr>
                                            <td>{{ payment.payment_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td><strong>₹{{ "%.2f"|format(payment.amount) }}</strong></td>
                                            <td>₹{{ "%.2f"|format(payment.interest_amount) }}</td>
                                            <td>₹{{ "%.2f"|format(payment.principal_amount) }}</td>
                                            <td>
                                                <span class="badge bg-{{ 'primary' if payment.payment_method == 'cash' else 'info' }}">
                                                    {{ payment.payment_method.title() if payment.payment_method else 'N/A' }}
                                                </span>
                                            </td>
                                            <td>{{ payment.transaction_id or '-' }}</td>
                                            <td>
                                                {% if payment.status == 'verified' %}
                                                    <span class="badge bg-success">{{ _('Verified') }}</span>
                                                {% elif payment.status == 'pending' %}
                                                    <span class="badge bg-warning">{{ _('Pending') }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger">{{ _('Rejected') }}</span>
                                                {% endif %}
                                            </td>
                                            {% if has_any_cashback %}
                                            <td>
                                                {% set payment_cashback = payment_cashback_map.get(payment.id, 0) %}
                                                {% if payment_cashback > 0 %}
                                                    <span class="badge" style="background: linear-gradient(135deg, #5f1e67 0%, #f5576c 100%); color: white;">
                                                        <i class="fas fa-coins me-1"></i>₹{{ "%.2f"|format(payment_cashback) }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            {% endif %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">{{ _('No payments yet') }}</h5>
                                <p class="text-muted">{{ _('This loan doesn\'t have any payment history.') }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Notes -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-sticky-note me-2"></i>{{ _('Loan Notes') }}
                            </h5>
                            <button class="btn btn-sm btn-outline-info" onclick="toggleNotesEdit()">
                                <i class="fas fa-edit"></i> {{ _('Edit') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="notesDisplay">
                                {% if loan.customer_notes %}
                                    <p class="mb-0 text-muted">{{ loan.customer_notes }}</p>
                                {% else %}
                                    <p class="mb-0 text-muted fst-italic">{{ _('No notes added yet. Click Edit to add notes.') }}</p>
                                {% endif %}
                            </div>
                            <div id="notesEdit" style="display: none;">
                                <form method="POST" action="{{ url_for('customer_edit_notes', instance_name=instance_name, loan_id=loan.id) }}">
                                    <textarea class="form-control" 
                                              name="customer_notes" 
                                              rows="3" 
                                              placeholder="{{ _('Add your notes about this loan...') }}">{{ loan.customer_notes or '' }}</textarea>
                                    <div class="mt-2">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-save"></i> {{ _('Save') }}
                                        </button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleNotesEdit()">
                                            <i class="fas fa-times"></i> {{ _('Cancel') }}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle notes edit mode
function toggleNotesEdit() {
    const display = document.getElementById('notesDisplay');
    const edit = document.getElementById('notesEdit');
    
    if (display && edit) {
        if (display.style.display === 'none') {
            display.style.display = 'block';
            edit.style.display = 'none';
        } else {
            display.style.display = 'none';
            edit.style.display = 'block';
        }
    }
}

// Set current date/time as default for payment date
document.addEventListener('DOMContentLoaded', function() {
    const paymentDateInput = document.getElementById('payment_date');
    if (paymentDateInput) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const dateTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
        paymentDateInput.value = dateTimeString;
    }
    
    // Form validation
    const paymentForm = document.getElementById('manual-payment-form');
    if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
            const amountInput = document.getElementById('amount');
            if (amountInput) {
                const amount = parseFloat(amountInput.value);
                const maxAmount = {{ loan.remaining_principal if loan.remaining_principal is not none else 0 }};
                
                if (amount > maxAmount) {
                    e.preventDefault();
                    alert('Payment amount cannot exceed the remaining balance of ₹' + maxAmount.toFixed(2));
                    return;
                }
                
                if (amount <= 0) {
                    e.preventDefault();
                    alert('Payment amount must be greater than ₹0');
                    return;
                }
                
                // Confirmation
                if (!confirm('Make payment of ₹' + amount.toFixed(2) + '?')) {
                    e.preventDefault();
                }
            }
        });
    }
});
</script>
{% endblock %}
